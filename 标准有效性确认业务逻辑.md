## 标准有效性确认业务逻辑
### 前台设计

#### 1 登陆提醒
1.1 用户只有在登陆之后才能进行标准有效性确认的操作，如果用户没有登陆，那么提示用户登陆后才能操作。
#### 2 前台页面
2.1 用户信息填写。用户在标准有效性确认页填写委托人信息，并上传<a href="http://p39n65xck.bkt.clouddn.com/%E6%A0%87%E5%87%86%E6%9C%89%E6%95%88%E6%80%A7%E7%A1%AE%E8%AE%A4%E6%B8%85%E5%8D%95.docx">标准有效性确认清单</a>。
![用户界面](http://p39n65xck.bkt.clouddn.com/wechat/180425/H3ceJLc5a5.jpg)
2.2 用户选中邮寄，弹出提示窗口告诉用户为到付件，需自己承担邮费。

2.2 数据有效性验证。（表单不为空、数据格式验证、附件内容和格式验证）
#### 3 业务逻辑
3.1 用户登陆之后，若检测到该用户之前提交的标准有效性确认请求需要修改，则弹出提醒的对话框。内容为`您于2018-04-15申请的标准有效性确认存在错误，请重新修改后再次提交`。对话框按钮为`修改`和`忽略`。

3.2 用户登陆之后，点击有效性确认链接，以标签页的形式显示该用户`已完成`、`未完成`的列表。**当且仅当用户之前上传的“标准有效性确认清单”有错误报告返回时，未完成列表才会显示可以修改的按钮。**其他情况不允许用户再修改。

- `已完成`列表按照时间倒序显示用户所有已完成的有效性确认历史，提供有效性确认报告下载功能。报告格式为pdf。
![已完成列表](http://p39n65xck.bkt.clouddn.com/wechat/180424/HdK1l2Aje5.jpg) 
- `未完成`列表按照时间倒序显示用户所有未完成的有效性确认历史，包括需要修改的记录。每条记录显示当前处理状态，状态有`待修改`和`进行中`两种状态。如果该条记录需要修改，则用户可以查看错误报告。
![未完成列表](http://p39n65xck.bkt.clouddn.com/wechat/180424/EdddHDAfKG.jpg)
3.3 用户点击修改按钮，页面跳转到“标准有效性确认”表单的提交页面，允许用户重新修改委托人信息以及上传改正之后的附件。

### 后台处理

#### 1 权限管理
1.1 超级管理员账号，可以给子账号分配不同的权限，根据分配的权限，子账号可以执行权限之内的操作。

1.2 有效性确认的处理流程分为三个步骤，**1、出具有效性确认报告**，**2、审核报告**，**3、批准**。每个步骤由不同的人操作。不同权限的管理员登陆后台之后只能看到当前自己权限能处理的数据。权限依次为`经办`、`审核`、`批准`
#### 2 功能分类
“标准有效性确认”后台分为`有效性确认`、`数据统计`、`提醒和送达`三块功能。

#### 3 有效性确认

3.1 页面显示

- 经办权限<br>
默认按照时间倒序显示**待确认**的数据。待确认：用户提交了有效性确认申请，管理员还未进行有效性确认操作或已进行有效性确认，但审核未通过。管理员可以通过点击退回意见查看了解退回原因。

![经办权限有效性确认待确认页面](http://p39n65xck.bkt.clouddn.com/wechat/180424/1DGA9C25cK.jpg)

- 审核权限<br>
默认按照时间倒序显示**待审核**的数据。待审核：用户数据没有错误，管理员已进行有效性确认操作并生成有效性确认报告，但报告还未进行审核或批准报告已生成但批准未通过。管理员可以通过点击退回意见查看了解退回原因。

![审核权限待审核页面](http://p39n65xck.bkt.clouddn.com/wechat/180424/2LBG4CLaI4.jpg)

- 批准权限<br>
默认按照时间倒序显示**待批准**的数据。待批准：有效性确认报告已通过审核，但还未批准。

![批准权限待批准页面](http://p39n65xck.bkt.clouddn.com/wechat/180424/me0FJ9L6CC.jpg)

3.2 业务逻辑

3.2.1 具有经办权限的管理员点击确认按钮之后，系统解析用户上传的附件内容。逐行读取标准号，并将标准号在数据库中检索。

3.2.2 在检索过程中若附件有错误

若在解析附件时发生错误，此用户的有效性确认请求全部停止，同时弹出错误提示（`有效性确认报告生成失败，请到“提醒和送达”进行处理。`），生成excel格式的错误报告，将该条记录标为待修改状态。同时该记录消失，流转到“提醒与送达”功能。
可能出现的错误：
- 用户提供的标准号不存在
- 用户提供的标准号重复
- 附件内容为空
![错误报告格式](http://p39n65xck.bkt.clouddn.com/wechat/180424/mJfJ2iIAf7.png)

3.2.3 在检索过程中若附件无错误

- 若该标准已废止，则在有效性确认报告中的标准状态一栏记为`废止`，若该标准有替代标准，则在“更新标准”一栏显示为被代替的标准号。格式为`被xxxx代替`；
- 若该标准部分废止，则在有效性确认报告中的标准状态一栏记为`部分废止`，在“更新标准”一栏显示为被代替的标准号。格式为`部分被xxxx代替`；
- 若该标准现行有效，则在有效性确认报告中的标准状态一栏记为`现行`，在“更新标准”一栏显示`无更新`。
- 按照模板格式生成标准有效性确认报告。在“承办人（签字）”一栏后显示电子签名。<a href="http://p39n65xck.bkt.clouddn.com/%E7%95%9C%E6%A3%80%E4%B8%AD%E5%BF%832018002.docx">模板-畜检中心2018002</a>
- 弹出操作成功的提示（`有效性确认报告已生成，等待审核！`）。

有效性确认报告生成之后，该条记录消失，此时状态由未确认变为待审核。流转到待审核流程。

3.2.4 具有审核权限的管理员登陆后台之后，点击查看按钮可以查看已经生成的有效性确认报告，若报告无问题，点击“通过”按钮，在“审核人（签字）”一栏后显示电子签名，该条记录消失，状态由待审核变为待批准，流传到待批准流程。若报告有问题，点击“不通过”按钮，则弹出窗口，输入退回意见，此时状态由待审核变为待确认。

3.2.5 具有批准权限的管理员登陆后台之后，点击查看按钮可以查看已经生成的有效性确认报告，若报告无问题，点击“通过”按钮，在“批准人（签字）”一栏后显示电子签名，该条记录消失，状态由待批准变为已完成。点击“不通过”按钮，则弹出窗口，输入退回意见，此时状态由待批准变为待审核。

#### 4 数据统计

4.1 检索条件
> - 委托单位
> - 委托时间
> - 行政区划
> - 完成时间
> - 当前状态
> - 取件方式
> - 是否已取

4.2 检索要求

4.2.1 当前状态有`未完成`、`已完成`两种状态。未完成是指处于待修改、待确认、待审核、待批准状态的记录，已完成是指已通过批准的记录。<br>
4.2.2 取件方式有自取、邮寄、E-mail三种方式<br>
4.2.3 委托时间和完成时间应该提供一个时间区间查询<br>
4.2.4 检索出来的数据，支持查看和下载有效性确认报告<br>
4.2.5 经办权限、审核权限、批准权限管理员均可以使用数据统计功能。

4.3 检索结果显示
![检索结果显示](http://p39n65xck.bkt.clouddn.com/wechat/180424/A8dga3cA50.jpg)

4.4 报表生成

在搜索的结果列表下面放置`生成报表`按钮，按照各种条件检索出来的结果，均支持生成excel报表。

#### 5 提醒和送达

5.1 经办权限的管理员可以看到该功能

5.2 错误报告提醒
显示所有检索过程中出现错误且还未提醒用户的记录。点击发送，将错误报告以附件的形式发送一份邮件给用户，点击提醒，表示该记录标记为已电话提醒用户。邮件未发送时，显示`发送`的链接，邮件发送后，显示`已发送`，未电话提醒时，显示`提醒`的链接，电话提醒后，显示`已提醒`。只有既发送了邮件，又电话提醒之后，该记录才会消失。
![错误报告提醒](http://p39n65xck.bkt.clouddn.com/wechat/180425/HG1885GGdD.jpg)

5.3 有效性确认报告送达
所有完成的报告需要在此处选择取件方式，确保用户已取件。勾选任一取件方式，弹出再次确认的对话框，确认后该条记录才会消失。
![取件确认](http://p39n65xck.bkt.clouddn.com/wechat/180424/e89C6LdKaf.png)


1. 去掉电话提醒
2. 确认的地方可以查看用户提交的清单，没有问题了再生成确认报告。增加手动退回